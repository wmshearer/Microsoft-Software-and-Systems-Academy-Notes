# AKS Scaling Options

## Scaling Concepts
- Scale pods (replicas) and/or scale nodes (cluster capacity)
- Manual scaling:
  - Set fixed replica count or node count to control cost
  - Kubernetes schedules new pods or drains nodes to match target count
  - Node scale-down in VMSS clusters follows VMSS logic for node removal

## Horizontal Pod Autoscaler (HPA)
- Automatically scales pod replica count based on resource demand
- Configure per deployment:
  - minReplicas / maxReplicas
  - metric target (commonly CPU)
- Polling behavior:
  - HPA checks Metrics API every 15s
  - Metrics API pulls from kubelet every 60s
  - Effective HPA update cadence: ~60s
- Scaling behavior:
  - Scale up quickly on increased load
  - Scale down only if above minReplicas
- Cooldown:
  - Prevents rapid oscillation/race conditions
  - No scale-up delay (since Kubernetes 1.12)
  - Default scale-down delay: 5 minutes

## Cluster Autoscaler
- Automatically scales node count in node pools based on pod scheduling needs
- Checks metrics frequently (default ~10s)
- Typically paired with HPA:
  - HPA changes pod count
  - Cluster autoscaler changes node capacity to fit pods
- Scale out:
  - Trigger: pods pending/unschedulable due to resource constraints
  - Adds nodes, then scheduler places pods
  - Node provisioning takes minutes → pods may wait
- Scale in:
  - Trigger: sustained unused capacity
  - Default: nodes unused ~10 minutes → eligible for deletion
  - Pods rescheduled to remaining nodes during scale-in
- Scale-down blockers:
  - Pods can’t move (constraints/placement rules)
  - Pod Disruption Budget (PDB) too restrictive
  - nodeSelector / affinity / anti-affinity prevents rescheduling

## Burst Scaling with Azure Container Instances (ACI) via Virtual Nodes
- Used for rapid burst demand when VM nodes aren’t ready yet
- ACI appears as a virtual node (virtual kubelet)
- Kubernetes schedules eligible pods to ACI through virtual nodes
- No app changes required
- Networking:
  - Virtual nodes deployed to another subnet in same VNet as AKS
  - Traffic secured within VNet

## Node Pool Scaling (Portal Concept)
- Node pools → scale node count
- Autoscale recommended:
  - Set min and max node count
  - Apply to enable node autoscaling

## Cluster Autoscaler Management (Best Practice)
- Do NOT manually configure VMSS autoscale in Azure portal/CLI
- Let Kubernetes cluster autoscaler control scaling behavior

## Enable/Disable Cluster Autoscaler (CLI)

### Enable on New Cluster
```bash
az group create --name myResourceGroup --location eastus

az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --vm-set-type VirtualMachineScaleSets \
  --load-balancer-sku standard \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

### Enable on Existing Cluster
```bash
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

### Disable Cluster Autoscaler
```bash
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --disable-cluster-autoscaler
```
- Disabling does not remove nodes automatically
- Manual scaling after disable:
```bash
az aks scale --resource-group myResourceGroup --name myAKSCluster --node-count <N>
```

## Module Assessment Answers
1. Purpose of HPA:
- **Correct answer:** To monitor resource demand and automatically scale the number of pods based on defined metrics such as CPU usage

2. Purpose of Kubernetes cluster autoscaler:
- **Correct answer:** To adjust the number of nodes based on the requested compute resources in the node pool

3. Purpose of the cluster autoscaler component in AKS:
- **Correct answer:** Enables the automation and validation of the creation and teardown of environments to help deliver secure and stable application hosting platforms
