# AKS Baseline Cluster Architecture

## Purpose
- Recommended baseline architecture for AKS
- Based on Azure Well-Architected Framework
- Focused on cluster infrastructure, not workloads
- Designed for production and preproduction
- Supports secure traffic flow and multi-region growth

## Network Topology: Hub-Spoke
- Hub and spoke VNets connected via peering
- Supports isolation, governance, and least privilege
- Reduces public internet exposure
- Scales easily by adding new spokes
- Enables shared services (firewall, DNS)
- Suitable for multi-subscription environments
- All web workloads require WAF

## Hub Virtual Network
- Central connectivity and observability
- Shared services managed by central IT

### Hub Subnets
- Azure Firewall subnet
  - Secures outbound traffic
  - Centralized firewall policies
- Gateway subnet
  - VPN or ExpressRoute connectivity
- Azure Bastion subnet
  - Secure management access
  - No public IP exposure

## Spoke Virtual Network
- Hosts AKS cluster and related resources

### Spoke Subnets
- Application Gateway subnet
  - Layer 7 load balancer
  - WAF enabled (v2 SKU)
  - Public frontend IP
- Ingress subnet
  - Ingress controller
  - Internal load balancers
- AKS node subnet
  - System node pool (core services)
  - User node pool (workloads + ingress)
- Private Link subnet
  - Private endpoints for:
    - Azure Container Registry
    - Azure Key Vault
  - Reduces traffic across VNet peering
  - Keeps cluster-related resources local

## IP Address Planning
- VNet must accommodate:
  - Nodes
  - Pods
  - Upgrade surge nodes
  - Rolling update pods
  - Private Link endpoints

### Upgrade Considerations
- Temporary nodes created during upgrades
- Temporary pods during rolling updates
- Replace strategy reuses pod IPs

### Scalability Planning
- Plan for node scale-out (example: 400% growth)
- Each pod requires an IP address
- Pod density directly impacts subnet size
- Multiple workloads may require:
  - Separate node pools
  - Additional subnets
  - Multiple ingress controllers

## Node Pools and Compute
- Each node pool maps to a VM Scale Set
- Nodes are Azure VMs

### System Node Pool
- Smaller VM size
- Example: DS2_v2
- Minimum recommended nodes: 3
- Hosts core cluster services

### User Node Pool
- Larger VM sizes for pod density
- Minimum recommended nodes: 2
- Example production size: DS4_v2
- Target workload utilization: 80%
- Reserve 20% for AKS services
- Start max pods per node at ~30

## Identity and Access (Microsoft Entra ID)

### Inside-Out Access (AKS → Azure)
- Managed identities recommended
- Avoid service principals and secrets
- Two main identities:
  - Cluster identity (control plane operations)
  - Kubelet identity (pull images from ACR)

### Azure Role Assignments
- Network Contributor
- Monitoring Metrics Publisher
- AcrPull

### Image Pull Best Practice
- Grant AcrPull to kubelet managed identity
- Avoid imagePullSecrets and stored credentials

### Outside-In Access (Users → AKS)
- kubectl access authenticated via Microsoft Entra
- Two access models:
  - Entra ID + Kubernetes RBAC
  - Azure RBAC for Kubernetes

## Network Flow Security

### Traffic Types
- Ingress: client → workload
- Egress: pod/node → external service
- Pod-to-pod: internal communication
- Management: client → Kubernetes API

### Ingress Security
- HTTPS only
- TLS v1.2 minimum
- Strict SNI
- End-to-end TLS

### Ingress Flow
- Client → Application Gateway (TLS + WAF)
- Application Gateway → internal load balancer (re-encrypted)
- Ingress controller → pods
- Certificates stored in Key Vault
- Mounted via CSI driver

## Scaling Strategy

### Recommended Approach
- Autoscaling preferred over manual scaling

### Horizontal Pod Autoscaler (HPA)
- Scales pod replicas
- Metrics:
  - CPU (default)
  - Memory
  - Custom metrics
- Requires min and max replica limits
- Uses Kubernetes Metrics API

### Cluster Autoscaler
- Scales node count in node pools
- Triggered by unschedulable pods
- Removes underutilized nodes
- Configured per user node pool
- Requires min and max node limits
- Recommended minimums:
  - User node pool: 2
  - System node pool: 3

## AKS Cluster Creation (Summary)
- Control plane is managed and free
- Nodes are customer-managed Azure VMs
- Supports multiple node pools
- Supports Linux and Windows workloads
- ACR integration during creation
- VNet selection during creation

## Module Assessment Answers

### Assessment 1
1. Recommended approach for scaling Kubernetes clusters:
- **Correct answer:** Autoscaling

2. What does `kubectl apply` do?
- **Correct answer:** Applies a configuration to a resource by filename or stdin

3. Why plan VNet address space carefully?
- **Correct answer:** To ensure that all entities that receive traffic have an IP address allocated from the subnet address space
