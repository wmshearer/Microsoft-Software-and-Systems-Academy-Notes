# AKS Pod Governance, Storage, and Deployments

## Azure Policy for AKS Pods
- Enforces pod security at scale
- Uses Gatekeeper v3 admission controller
- Centralized governance and compliance reporting
- Preferred over Pod Security Admission for enterprise use
- Supports built-in and custom policies and initiatives

## Azure Policy Add-on for AKS
- Required to enforce Azure Policy on pods
- Manages:
  - Policy assignment monitoring
  - ConstraintTemplate and Constraint deployment
  - Compliance reporting back to Azure
- Linux node pools only
- Standalone Gatekeeper installs not supported
- OS-specific policies apply (e.g., Linux-only restrictions)

## Common AKS Pod Security Initiatives
- Pod Security Baseline (Linux)
- Pod Security Restricted (Linux)

## Policy Assignment Notes
- Requires Azure RBAC:
  - Resource Policy Contributor
  - Owner
- Scope must include the AKS cluster
- Enforcement modes:
  - Enabled (Deny)
  - Disabled (Audit only)
- Initial enforcement delay: ~20 minutes
- Compliance window: last 45 minutes
- Existing non-compliant pods continue running
- Rescheduled non-compliant pods are blocked

## Validating Policy Enforcement
- Non-compliant pod creation denied
- Example violation:
  - Privileged containers blocked by Gatekeeper

## AKS Storage Overview
- Supports stateless and stateful workloads
- Storage selection based on:
  - Performance
  - Availability
  - Security
  - Cost
  - Recoverability

## AKS Storage Options
- Application-level (managed databases):
  - Azure SQL
  - Azure Database for MySQL/PostgreSQL
  - Cosmos DB
- File-level access:
  - Azure Files (Standard / Premium)
  - Azure NetApp Files
- Block-level (self-managed):
  - Azure Premium SSD
  - Premium SSD v2
  - Ultra Disk
  - Azure Blob (BlobFuse or direct)
- Block-level (fully managed):
  - Azure Container Storage

## AKS Volume Types
- emptyDir:
  - Temporary pod storage
  - Deleted with pod
- secret:
  - Inject sensitive data
- configMap:
  - Inject configuration
- PersistentVolume (PV):
  - Persists beyond pod lifecycle

## Persistent Volumes in AKS
- Backed by:
  - Azure Disks
  - Azure Files
- Can be:
  - Pre-provisioned
  - Dynamically provisioned
- Dynamic provisioning uses StorageClass

## StorageClass
- Defines storage characteristics
- Maps to Azure storage resources
- Defines reclaimPolicy:
  - Delete
  - Retain
- AKS includes default StorageClasses

## PersistentVolumeClaim (PVC)
- Requests storage based on:
  - StorageClass
  - Access mode
  - Size
- Dynamically provisions storage if needed
- PV binds to PVC once fulfilled

## Deployments vs Pods
- Pods:
  - Ephemeral
  - Not self-healing when standalone
- Deployments:
  - Manage replica sets
  - Provide high availability
  - Enable rolling updates and rollbacks
  - Support Pod Disruption Budgets
- Recommended for production workloads

## Deployment Updates
- Controlled rollout process:
  - Drain old replicas
  - Create new replicas
  - Continue until complete
- Supports image, config, and storage updates

## Helm
- Kubernetes package manager
- Uses reusable Helm charts
- Simplifies application lifecycle management
- Charts can be stored in ACR or repositories

## Namespaces
- Logical grouping and isolation
- Resource names unique within namespace
- Cannot be nested
- Default namespaces:
  - default
  - kube-system
  - kube-public

## Module Assessment Answers

### Assessment
1. Benefit of using Kubernetes Deployments:
- **Correct answer:** Deployments enable automation and validation of the creation and teardown of environments to help deliver secure and stable application hosting platforms

2. Purpose of a StorageClass in AKS:
- **Correct answer:** To define storage characteristics and the reclaim policy for underlying Azure storage resources

3. Purpose of creating a custom StorageClass:
- **Correct answer:** To define the properties of a persistent volume that will be used by a persistent volume claim

4. Storage options for AKS containerized workloads:
- **Correct answer:** Choose from platform managed databases, disks, and file and blob storage
