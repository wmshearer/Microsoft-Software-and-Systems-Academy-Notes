# Microsoft Defender for Cloud Apps Framework

## Cloud Access Security Broker (CASB) Basics

- Cloud access security brokers (CASBs) are security policy enforcement points between:
  - Cloud service users (your org)
  - Cloud service providers (software-as-a-service, platform-as-a-service, infrastructure-as-a-service)
- Purpose:
  - Enforce enterprise security policies as cloud resources are accessed
  - Provide monitoring + control across cloud services
- Microsoft Defender for Cloud Apps is Microsoft’s CASB
  - Works with Microsoft + third-party cloud services
  - Integrates with Microsoft security tools for centralized management and automation

## Defender for Cloud Apps Framework: 4 Elements

- Discover and control Shadow IT
  - Identify unknown cloud apps and services used by users (often 1,000+)
  - Reduce risk from unsanctioned / noncompliant tools
- Protect sensitive information anywhere in the cloud
  - Data loss prevention (DLP) controls for data at rest + data movement
- Protect against cyberthreats and anomalies
  - Uses anomaly detection, user and entity behavioral analytics (UEBA), and rule-based detections
- Assess compliance of cloud apps
  - Compare apps to regulations/standards
  - Prevent leaks to noncompliant apps
  - Limit access to regulated data

# Cloud Discovery

## What Cloud Discovery Does

- Uses traffic logs to detect cloud app usage (including Shadow IT)
- Compares logs to a catalog of 16,000+ cloud apps
- Scores apps using 80+ risk factors
- Outputs:
  - App risk score (1 to 10)
  - App usage, top users, source internet protocol (IP) addresses
  - Sanctioned vs unsanctioned app usage
  - App Headquarters map

## How to Review Cloud Discovery Dashboard (Suggested Flow)

- Start with high-level usage overview
  - Identify top users and top source IP addresses
- Review app categories
  - See which categories dominate usage
  - Check how much is sanctioned
- Open Discovered apps
  - Review all apps in a category
  - Check risk scores
- Review App Headquarters map
- If an app is risky:
  - Mark as Unsanctioned
  - If Microsoft Defender for Endpoint is present, unsanctioned apps can be automatically blocked
  - If not, block via scripting at the data source and notify users

# Conditional Access App Control (Real-Time Control)

## What It Is

- Real-time monitoring and control of user sessions in cloud apps
- Integrates with an identity provider (IdP)
  - If Microsoft Entra ID is the identity provider, integration is direct
- Uses Microsoft Entra Conditional Access to route sessions to Defender for Cloud Apps for enforcement

## How It Works (High Level)

- In Microsoft Entra Conditional Access:
  - Define conditions:
    - Who (user/group)
    - What (cloud apps)
    - Where (locations/networks)
  - Under Session controls:
    - Select `Use Conditional Access App Control`
  - Choose built-in or custom controls (custom controls configured in Defender for Cloud Apps)

## Access and Session Policy Capabilities (Examples)

- Prevent data exfiltration
  - Block download, cut, copy, print for sensitive data (often on unmanaged devices)
- Protect on download
  - Require labeling/protection using Azure Information Protection before allowing download
- Prevent upload of unlabeled files
  - Block upload until the file is classified/labeled correctly
- Monitor sessions for compliance
  - Log user actions during the session for investigation
- Block access
  - Block user access to apps based on risk factors (example: client certificate use as device management)
- Block custom activities
  - Example: block sending messages containing sensitive content in collaboration apps

## Example: Block Sensitive Messages in Microsoft Teams

- Create a Microsoft Entra Conditional Access policy with:
  - Session: `Use Conditional Access App Control` + custom controls
- In Defender for Cloud Apps:
  - Create session policy from template:
    - `Block sending of messages based on real-time content inspection`
  - Set activity source:
    - Send Teams message
  - Enable content inspection
  - Set action:
    - Block + alert administrators
- User sees a notification when blocked

# Classify and Protect Sensitive Information (Information Protection)

## Azure Information Protection Integration

- Azure Information Protection is used to classify and protect files and email
- Requires enabling the Microsoft 365 app connector in Defender for Cloud Apps

## 4 Phases of Information Protection in Defender for Cloud Apps

## Phase 1: Discover data

- Connect apps so Defender for Cloud Apps can scan and classify
- Methods:
  - App connector
  - Conditional Access App Control

## Phase 2: Classify sensitive information

- Define what is “sensitive” for your organization
- Use:
  - 100+ predefined sensitive information types
  - Azure Information Protection labels:
    - Personal
    - Public
    - General
    - Confidential
    - Highly confidential
- Enable auto-scanning for labels:
  - Turn on option to automatically scan new files for Azure Information Protection labels

## Phase 3: Protect data (File policies)

- Create file policies to scan:
  - Data at rest
  - Real-time content
- Governance actions can include:
  - Trigger alerts and email notifications
  - Change sharing access
  - Quarantine files
  - Remove permissions
  - Move to trash folder

### File Policy Creation (Key Fields)

- Policy severity
  - Used for prioritization + notification behavior
- Category
  - Typically Data Loss Prevention (DLP) for file policies
- Filters
  - Keep as narrow as possible to reduce false positives
- Apply to apps
  - All files excluding selected folders, or selected folders (for Box, SharePoint, OneDrive, Dropbox)
- Apply to users/groups
  - All owners, selected groups, or exclude groups
- Content inspection method
  - Built-in DLP
  - Data Classification Services (DCS) (recommended for unified labeling across Microsoft 365, Azure Information Protection, and Defender for Cloud Apps)
- Governance
  - Choose actions taken on a match
- Create policy when complete

## Phase 4: Monitor and report

- Monitor dashboards and alerts
- Example: review file-related alerts by filtering Alerts category to DLP
- Investigate, dismiss, or export alerts to `.CSV`

# Detect Threats (Anomaly Detection + UEBA)

## Core Concepts

- Out-of-the-box anomaly detection policies use:
  - User and entity behavioral analytics (UEBA)
  - Machine learning
- These detections are nondeterministic
  - Trigger only when behavior deviates from baseline

## Baseline Learning

- First 7 days:
  - Learns normal usage patterns for IPs, devices, locations, apps
  - Builds baseline to reduce false positives
- Evaluates sessions using 30+ indicators grouped into risk factors:
  - Risky IP address
  - Login failures
  - Admin activity
  - Inactive accounts
  - Location
  - Impossible travel
  - Device and user agent
  - Activity rate

## Common Anomaly Detection Policies

- Impossible travel
- Activity from infrequent country
- Malware detection
- Ransomware activity
- Activity from suspicious IP addresses
- Suspicious inbox forwarding
- Unusual multiple file downloads
- Unusual administrative activities

## Discovery Anomaly Detection Policy (Example)

- Detects unusual spikes in:
  - Downloaded data
  - Uploaded data
  - Transactions
  - Users per cloud app
- Compared against baseline
- Extreme increases trigger alerts
- Configurable sensitivity controls how many alerts trigger

## Fine-Tuning and Suppression

- Goal: reduce alert fatigue from false positives (example: virtual private network behavior)
- Suppression types:
  - System (always suppressed)
  - Tenant (common for the tenant)
  - User (common for a specific user)
- Sensitivity affects suppression:
  - Low: System + Tenant + User suppression
  - Medium: System + User suppression
  - High: System-only suppression
- Some detections can be configured to include:
  - Successful logins only, or failed + successful

## Scoping Policies to Users/Groups

- Each anomaly detection policy can include/exclude specific users/groups
- Flow:
  - Defender portal > Cloud apps > Policies > Policy management
  - Filter Type: Anomaly detection policy
  - Select policy > Scope
  - Set to specific users/groups
  - Include and exclude as needed
  - Select Update

# Module Assessment Answers

## Question 1
- At-a-glance overview of apps being used
- Answer: Use the Cloud Discovery Dashboard

## Question 2
- Defender for Cloud Apps framework includes which option
- Answer: Discover and control the use of Shadow IT

## Question 3
- Feature of Conditional Access App Control policies
- Answer: Protect on download

## Question 4
- Ensure a file is sent into quarantine for admin review
- Answer: When creating a file policy, select Quarantine for admin

## Question 5
- Alert when same user appears to sign in from distant locations in short time
- Answer: Impossible travel
