# Introduction to Microsoft Defender for Identity

## Microsoft Defender for Identity Overview

- Cloud-based security solution for on-premises Active Directory signals
- Detects and helps investigate:
  - Advanced threats
  - Compromised identities
  - Malicious insider actions
- Provides investigation timelines for faster triage
- Integrated into Microsoft Defender XDR (Extended Detection and Response)

## Key Benefits

- Monitor users, entity behavior, and activities using learning-based analytics
- Protect identities and credentials stored in Active Directory
- Detect suspicious activities across the attack kill chain
- Provide clear incident information on a timeline for fast triage
- Build behavioral baselines per user and detect anomalies
- Sensors monitor domain controllers for comprehensive identity activity visibility

# Reduce Identity Attack Surface

## Security Posture and Recommendations

- Surfaces identity configuration issues and security best practices
- Security reports and user profile analytics reduce attack surface
- Visual lateral movement paths help identify how attackers could move through the environment
- Reports can identify:
  - Clear-text password authentication usage
  - Risky identity configurations and policies

# Detect Attacks Across the Kill Chain

## Typical Identity Attack Progression

- Attackers often start with low-privilege access
- Move laterally to reach:
  - Privileged accounts
  - Domain administrators
  - Sensitive data
- Microsoft Defender for Identity detections cover:
  - Reconnaissance
  - Credential compromise
  - Lateral movement
  - Domain dominance

## Examples of Detections

- Lightweight Directory Access Protocol (LDAP) reconnaissance
  - Detects suspicious enumeration queries (especially targeting sensitive groups)
- Brute force and password spray
  - Detects multiple authentication failures
  - Includes Kerberos and NTLM patterns
- Pass-the-ticket
  - Detects Kerberos ticket reused across multiple computers
- DCShadow
  - Detects rogue domain controller replication activity attempting directory changes

# Configure Microsoft Defender for Identity Sensors

## High-Level Enablement Steps

- Create Microsoft Defender for Identity instance in portal
- Specify on-premises Active Directory service account in portal
- Download and install sensor package
- Install sensor on all domain controllers
- Optional: Integrate virtual private network (VPN) solution
- Exclude sensitive accounts identified during design
- Configure permissions for Security Account Manager Remote (SAM-R) calls
- Integrate with Microsoft Defender for Cloud Apps
- Optional: Integrate with Microsoft Defender XDR

## Architecture (Core Concepts)

- Sensor runs on domain controllers
- Sensor parses:
  - Domain controller event logs
  - Domain controller network traffic
- Sends parsed telemetry (not all raw logs) to Defender for Identity cloud service

## Sensor Core Functions

- Capture and inspect domain controller network traffic
- Read Windows events from domain controllers
- Receive Remote Authentication Dial-In User Service (RADIUS) accounting info from VPN provider
- Retrieve Active Directory user/computer data
- Resolve users, groups, computers into entities
- Send relevant data to Defender for Identity cloud service

## Requirements (Key Points)

- Windows Server update requirement:
  - KB4487044 required on Windows Server 2019
- Supported domain controller operating systems:
  - Windows Server 2008 R2 SP1 (not Server Core)
  - Windows Server 2012
  - Windows Server 2012 R2
  - Windows Server 2016 (Server Core supported; Nano Server not supported)
  - Windows Server 2019 (Server Core supported; Nano Server not supported)
- Supports read-only domain controllers (RODC)
- Recommended resources:
  - 10 GB disk
  - Minimum 2 CPU cores
  - Minimum 6 GB RAM
  - High performance power option
- Virtual machines:
  - Dynamic memory / memory ballooning not supported

## Installation and Configuration Flow

- Run sensor setup and follow wizard
- Installer detects server type:
  - Domain controller installs Defender for Identity sensor
  - Dedicated server installs standalone sensor (for port mirroring scenarios)
- Configure during install:
  - Installation path (default recommended)
  - Access key from Defender for Identity portal
- Post-install:
  - Open Defender for Identity portal
  - Go to Configuration > Sensors
  - Configure sensor details:
    - Description (optional)
    - Domain Controllers list (required for standalone sensor)
    - Ensure at least one domain controller listed is a global catalog
    - Select capture network adapters:
      - Sensor on domain controller: adapters used for internal communication
      - Standalone sensor: adapters receiving mirrored traffic

# Investigate Compromised Accounts and Domain Attacks

## Alert Structure and Phases

- Alerts categorized by kill chain phase:
  - Reconnaissance
  - Compromised credentials
  - Lateral movement
  - Domain dominance
  - Exfiltration
- Each alert includes:
  - Title
  - Description
  - Evidence (with direct links to users and computers)
  - Downloadable Excel report

## Example Investigation Flow (Domain Compromise)

- Reconnaissance alert:
  - User and IP reconnaissance via Server Message Block (SMB)
  - Evidence includes command/activity log
- Credential theft progression:
  - Overpass-the-hash (Kerberos) indicates credential material used for Kerberos auth
  - Pass-the-ticket indicates stolen Kerberos ticket reuse
- Escalation:
  - Remote command execution on domain controller
  - Command creates new user in Administrators group
- Likely conclusions:
  - Initial endpoint compromise
  - Reconnaissance of administrator assets
  - Credential theft and lateral movement
  - Domain controller access
  - Creation of persistent domain admin account
  - Full domain compromise possible (e.g., Skeleton Key)

# Integrations with Other Microsoft Tools

## Microsoft Defender for Cloud Apps Integration

- Provides visibility into on-premises identity activity
- Correlates cloud and on-premises suspicious activity
- Defender for Identity policies appear in Defender for Cloud Apps policy management

## Microsoft Defender for Endpoint Integration

- Combines:
  - Defender for Identity domain controller visibility
  - Defender for Endpoint endpoint telemetry
- Allows viewing identity alerts from the endpoint context
- Helps analysts correlate endpoint process activity with credential theft events (e.g., Mimikatz)

# Module Assessment Answers

## Question 1
- Microsoft Defender for Identity requires an on-premises Active Directory environment.
- Answer: True

## Question 2
- Which describes advanced threats detected by Microsoft Defender for Identity?
- Answer: Reconnaissance

## Question 3
- Which is not a supported integration for Microsoft Defender for Identity?
- Answer: Intune
