# Microsoft Entra Identity Protection

## Introduction

- Protects user and workload identities by monitoring sign-in behavior and usage patterns
- Focuses on detecting compromised identities and risky sign-ins
- Integrated with Conditional Access and Security Information and Event Management (SIEM) tools
- Requires Microsoft Entra ID Premium P2 licensing

## Learning Objectives

- Review Identity Protection fundamentals
- Implement and manage:
  - User risk policy
  - Sign-in risk policy
  - Multifactor authentication (MFA) registration policy
- Monitor, investigate, and remediate risky users
- Explore Microsoft Defender for Identity

# Identity Protection Basics

## Core Capabilities

- Automates detection and remediation of identity-based risks
- Provides investigation data via the Microsoft Entra admin portal
- Exports risk data to third-party tools and SIEM platforms
- Uses trillions of daily signals from:
  - Microsoft Entra ID
  - Microsoft consumer accounts
  - Xbox and gaming telemetry

## Integration Points

- Conditional Access
  - Uses risk signals to block or challenge access
- Security Information and Event Management (SIEM)
  - Risk data exported for correlation and investigation

## Licensing Requirement

- Microsoft Entra ID Premium P2 is required for:
  - Risk policies
  - Detailed reports
  - Notifications
  - Multifactor authentication (MFA) registration policy

# Risk Detection and Classifications

## Identity Risk Detection Types

- Anonymous IP address
  - Tor browser or anonymizer virtual private networks (VPNs)
- Atypical travel
  - Sign-ins from unusual geographic locations
- Malware-linked IP address
- Unfamiliar sign-in properties
- Leaked credentials
- Password spray
- Microsoft Entra threat intelligence
- New country (detected by Microsoft Defender for Cloud Apps)
- Activity from anonymous IP address (Microsoft Defender for Cloud Apps)
- Suspicious inbox forwarding (Microsoft Defender for Cloud Apps)

# Permissions and Roles

## Required Roles for Identity Protection Access

- Security Reader
- Security Operator
- Security Administrator
- Global Reader

## Role Capabilities

- Security Administrator
  - Full access to Identity Protection
  - Cannot reset user passwords
- Security Operator
  - View reports
  - Dismiss user risk
  - Confirm safe or compromised sign-ins
  - Cannot configure policies or reset passwords
- Security Reader
  - View reports only
  - No configuration or remediation actions

# Risk Policies Overview

## Two Risk Policies

- User risk policy
  - Detects probability that a user account is compromised
- Sign-in risk policy
  - Detects probability that a specific sign-in was not performed by the legitimate user

## Policy Characteristics

- Automate response to detected risks
- Allow user self-remediation when properly configured
- Support exclusions (e.g., break-glass accounts)

## Microsoft Recommended Thresholds

- User risk policy: High
- Sign-in risk policy: Medium and above
- Balances security with user experience

## Prerequisites for Self-Remediation

- Users must be registered for:
  - Multifactor authentication (MFA)
  - Self-service password reset (SSPR)
- Combined security information registration is recommended

# Multifactor Authentication Registration Policy

## Purpose

- Ensures users are registered for MFA before being challenged
- Required for risk-based remediation

## Policy Characteristics

- Applies to all or selected users
- Cannot disable the requirement once enabled
- Enforced through Microsoft Entra Identity Protection

# Monitoring and Investigation

## Identity Protection Reports

- Risky users
  - User risk state, history, and remediation actions
- Risky sign-ins
  - Sign-in-level risk data (last 30 days)
- Risk detections
  - Individual detection events (last 90 days)

## Report Capabilities

- Filterable views
- Download as `.CSV` or `.JSON`
- Drill-down details for each detection
- Actions available per event

## Common Investigation Actions

- Confirm user compromised
- Confirm sign-in safe or compromised
- Dismiss user risk
- Reset user password
- Block user sign-in

# Risk Remediation Options

## Self-Remediation (Preferred)

- Triggered via risk policies
- Requires MFA and self-service password reset
- Automatically closes detections

## Manual Remediation

- Manual password reset
  - Temporary password
  - Forced password reset (requires MFA and SSPR)
- Dismiss user risk
  - Closes detections without changing credentials
- Close individual risk detections manually

## Unblocking Users

- Based on user risk:
  - Reset password
  - Dismiss user risk
  - Exclude user from policy
  - Disable policy
- Based on sign-in risk:
  - Sign in from familiar device or location
  - Exclude user from policy
  - Disable policy

# Microsoft Graph Integration

## Identity Protection APIs

- `riskDetection`
  - Query user and sign-in risk detections
- `riskyUsers`
  - Query users flagged as risky
- `signIn`
  - Query sign-in events with risk properties

## Common API Use Cases

- Identify offline risk detections:
  - `GET https://graph.microsoft.com/v1.0/identityProtection/riskDetections?$filter=detectionTimingType eq 'offline'`
- Identify users who passed MFA due to risk-based policy:
  - `GET https://graph.microsoft.com/v1.0/identityProtection/riskyUsers?$filter=riskDetail eq 'userPassedMFADrivenByRiskBasedPolicy'`

## Authentication Flow (High-Level)

- Register application in Microsoft Entra ID
- Grant Microsoft Graph application permissions
- Use client credentials flow
- Authenticate against:
  - `https://login.microsoft.com`
- Query Graph endpoints:
  - `https://graph.microsoft.com/v1.0/identityProtection/riskDetections`

# Workload Identity Protection

## Workload Identity Definition

- Identities used by applications or service principals
- Characteristics:
  - Cannot perform multifactor authentication
  - Often lack lifecycle management
  - Store secrets or credentials

## Requirements

- Microsoft Entra ID Premium P2
- Security Administrator, Security Operator, or Security Reader role

## Workload Identity Risk Detections

- Microsoft Entra threat intelligence
- Suspicious sign-ins
- Unusual credential additions to OAuth apps
- Admin-confirmed compromise
- Leaked credentials (preview)

## Conditional Access for Workload Identities

- Can block access when marked at risk
- Applies to single-tenant service principals
- Does not apply to:
  - Multi-tenant applications
  - Third-party software-as-a-service
  - Managed identities

# Microsoft Defender for Identity

## Overview

- Formerly Azure Advanced Threat Protection (Azure ATP)
- Cloud-based identity threat detection for on-premises Active Directory
- Detects:
  - Credential theft
  - Lateral movement
  - Malicious insider activity

## Core Components

- Defender for Identity portal
- Defender for Identity sensors
  - Installed on domain controllers
  - Installed on Active Directory Federation Services (AD FS) servers
- Defender for Identity cloud service
  - Runs in Microsoft Azure
  - Connected to Microsoft security intelligence

# Identity Risk Management Agent

## Purpose

- Uses a Large Language Model to proactively analyze risky users
- Suggests remediation actions before incidents occur

## Prerequisites

- Microsoft Entra ID Premium P2
- Security compute units (SCUs)
- Security Administrator role for activation

## Agent Capabilities

- Continuous or scheduled monitoring
- Risk investigation and summarization
- Suggested remediation actions
- Chat-based interaction
- Stores custom remediation preferences

## Available Remediation Actions

- Dismiss risk
- Reset password

# Module Assessment Answers

## Question 1
- Which task can a user with the Security Operator role perform?
- Answer: Confirm safe sign-in

## Question 2
- Which is the other risk policy besides user risk policy?
- Answer: Sign-in risk policy

## Question 3
- Which three Microsoft Graph APIs expose information about risky users and sign-ins?
- Answer: riskDetection, riskyUsers, signIns
