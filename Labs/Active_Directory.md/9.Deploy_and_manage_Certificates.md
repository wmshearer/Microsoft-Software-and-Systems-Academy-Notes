# Exercise 1: Configure Certificate Templates

## Scenario
After deploying the CA infrastructure, Contoso needs certificate templates:
- A new Web Server template for production servers
- A new User template that also supports Smart Card Logon
Then you’ll publish the templates and enroll a web cert on LON-SVR2.

## Task 1: Create a new template based on Web Server
- Sign in to LON-DC1 as Contoso\Administrator (Pa55w.rd)
- Server Manager → Tools → Certification Authority
- Expand ContosoCA → right-click Certificate Templates → Manage

- In Certificate Templates Console:
  - Find Web Server template → right-click → Duplicate Template
  - General tab:
    - Template display name: Production Web Server
    - Validity period: 3 (years)
  - Request Handling tab:
    - Check: Allow private key to be exported
  - Security tab:
    - Select Authenticated Users
    - Allow: Read, Enroll, Autoenroll
  - OK

- Close Certificate Templates Console

- Back in Certification Authority console:
  - Right-click Revoked Certificates → All Tasks → Publish → OK

## Task 2: Create a new user template that includes smart-card sign in
- In Certification Authority console:
  - Expand ContosoCA → Certificate Templates → Manage

- In Certificate Templates Console:
  - Right-click User template → Duplicate Template
  - General tab:
    - Template display name: Contoso User
  - Subject Name tab:
    - Clear: Include e-mail name in subject name
    - Clear: E-mail name
  - Extensions tab:
    - Select Application Policies → Edit
    - Add → Smart Card Logon → OK → OK
  - Superseded Templates tab:
    - Add → User → OK
  - Security tab:
    - Select Authenticated Users
    - Allow: Read, Enroll, Autoenroll
  - OK

- Close Certificate Templates Console

## Task 3: Configure templates so they can be issued
- In Certification Authority console on LON-DC1:
  - Right-click Certificate Templates → New → Certificate Template to Issue
  - Ctrl+select:
    - Contoso User
    - Production Web Server
  - OK

## Task 4: Enroll the Web Server certificate on LON-SVR2
- Switch to LON-SVR2
- Sign in as Contoso\Administrator (Pa55w.rd)

- Open Windows PowerShell ISE
- Run:
gpupdate /force

- Start → run:
certlm.msc

- Certificates (Local Computer):
  - Personal → right-click → All Tasks → Request New Certificate
  - Next → Next (Active Directory Enrollment Policy)

- Select template:
  - Production Web Server
  - Click: More information is required to enroll...

- Subject tab:
  - Subject name:
    - Type: Common name
    - Value: lon-svr2.contoso.com
    - Add
  - Alternative name:
    - Type: DNS
    - Value: lon-svr2.contoso.com
    - Add

- General tab:
  - Friendly name: LON-SVR2 Web Server
  - OK

- Back at Request Certificates:
  - Check Production Web Server → Enroll
  - Confirm Success → Finish

- Close Certificates console

### Bind certificate to IIS site
- Start → Server Manager → Tools → IIS Manager
- Expand LON-SVR2 → Sites → Default Web Site
- Actions pane → Bindings → Add
  - Type: https
  - SSL certificate: LON-SVR2 Web Server
  - OK → Close
- Close IIS Manager

### Validate from client
- Switch to LON-CL1
- Sign in as Contoso\Administrator (Pa55w.rd)
- Open Edge → browse:
https://lon-svr2.contoso.com
- Confirm:
  - IIS page loads
  - No certificate error
  - Lock icon shows connection is secure
- Close Edge

## Result
- Production Web Server + Contoso User templates created
- Templates published/issuable on ContosoCA
- LON-SVR2 has a valid HTTPS web server certificate bound in IIS


# Exercise 2: Enroll and Use Certificates

## Scenario
Contoso needs:
- User autoenrollment enabled (certs issued automatically)
- Smart-card enrollment via Enrollment Agents
- Ellen Mogensen is delegated Enrollment Agent rights for Marketing users
- Test certificate usage by digitally signing a Word document

## Task 1: Configure autoenrollment for users
- On LON-DC1:
  - Server Manager → Tools → Group Policy Management
  - Contoso.com → Default Domain Policy → Edit
  - User Configuration →
    Policies →
    Windows Settings →
    Security Settings →
    Public Key Policies

- Configure:
  - Certificate Services Client - Auto-Enrollment:
    - Configuration Model: Enabled
    - Check:
      - Renew expired certificates, update pending certificates, and remove revoked certificates
      - Update certificates that use certificate templates
    - OK

  - Certificate Services Client - Certificate Enrollment Policy:
    - Enrollment Policy tab:
      - Configuration Model: Enabled
      - Ensure Active Directory Enrollment Policy is checked/enabled
    - OK

- Close GPMC Editor + GPMC

## Task 2: Verify autoenrollment
- On LON-CL1:
  - Start → PowerShell ISE
  - Run:
gpupdate /force

- Then run:
certmgr.msc

- Certificates - Current User:
  - Personal → Certificates
  - Verify a cert issued for Administrator based on template: Contoso User
  - (You may need to scroll right to see template name)

- Close certmgr
- Sign out of LON-CL1

## Task 3: Configure the enrollment agent for smart-card certificates

### Allow Ellen to enroll Enrollment Agent certificate
- On LON-DC1:
  - Server Manager → Tools → Certification Authority
  - ContosoCA → Certificate Templates → Manage
  - Open Enrollment Agent template → Security tab → Add Ellen
  - Allow for Ellen:
    - Read
    - Enroll
  - OK
  - Close templates console

### Publish Enrollment Agent template
- In certsrv:
  - Certificate Templates → New → Certificate Template to Issue
  - Select Enrollment Agent → OK

### Enroll Ellen’s Enrollment Agent certificate
- Switch to LON-CL1
- Sign in as Contoso\Ellen (Pa55w.rd)
- Run:
certmgr.msc
- Certificates - Current User:
  - Personal → Certificates → right-click Certificates → All Tasks → Request New Certificate
  - Wizard:
    - Next → Next
    - Select Enrollment Agent → Enroll → Finish
- Sign out of LON-CL1

### Restrict who can be an Enrollment Agent + what they can issue
- Switch to LON-DC1
- In Certification Authority console:
  - Right-click ContosoCA → Properties
  - Enrollment Agents tab:
    - Select: Restrict Enrollment agents → OK
    - Enrollment agents section:
      - Add Ellen
      - Remove Everyone
    - Certificate Templates section:
      - Add Contoso User
      - Remove <All>
    - Permission section:
      - Add Marketing
      - Remove Everyone
  - OK

## Task 4: Use certificates for digital signing (Word)
- On LON-CL1:
  - Sign in as Contoso\Administrator (Pa55w.rd)
  - Open Word
  - Accept license if prompted
  - Create a blank doc → type some text → save to Desktop

- Insert a signature line:
  - Insert → Text → Signature Line dropdown → Microsoft Office Signature Line
  - Suggested signer: your name
  - Title: Administrator
  - Email: Administrator@contoso.com
  - OK

- Sign:
  - Right-click signature line → Sign…
  - Change → choose Administrator certificate (today’s date) → OK
  - Type your name in the signing box (or use image)
  - Sign → OK

- Close Word (save if prompted)
- Sign out

## Result
- Autoenrollment enabled + verified
- Ellen configured and enrolled as Enrollment Agent
- Enrollment Agent rights restricted properly (Ellen + Marketing + Contoso User template only)
- Digital signing tested successfully in Word


# Exercise 3: Configure and Implement Key Recovery

## Scenario
You need private key recovery procedures:
- Issue Key Recovery Agent (KRA) certificate to an administrator
- Configure CA to archive keys
- Create a template that archives private keys
- Recover Oscar’s private key after “loss” and restore certificate

## Task 1: Configure CA to issue KRA certificates
- Switch to LON-DC1
- Certification Authority console:
  - ContosoCA → Certificate Templates → Manage
  - Key Recovery Agent template → Properties
    - Issuance Requirements tab:
      - Clear: CA certificate manager approval
    - Security tab:
      - Confirm Domain Admins + Enterprise Admins have Enroll
  - OK
- Close templates console

- Back in Certification Authority console:
  - Certificate Templates → New → Certificate Template to Issue
  - Select Key Recovery Agent → OK
- Close Certification Authority console

## Task 2: Acquire the KRA certificate
- On LON-DC1 run:
certmgr.msc

- Certificates - Current User:
  - Personal → All Tasks → Request New Certificate
  - Next → Next
  - Select Key Recovery Agent → Enroll → Finish

- Verify:
  - Personal → Certificates contains KRA cert
  - (Scroll right and confirm “Key Recovery Agent” usage/template)
- Close certmgr

## Task 3: Configure the CA to allow key recovery (enable key archival)
- On LON-DC1:
  - Server Manager → Tools → Certification Authority
  - Right-click ContosoCA → Properties
  - Recovery Agents tab:
    - Check: Archive the key
    - Under Key recovery agent certificates → Add
    - OK in selection dialog
  - OK
  - Restart CA service when prompted: Yes

## Task 4: Configure a custom template for key archival
- On LON-DC1:
  - Certification Authority console → Certificate Templates → Manage
  - Duplicate User template
  - New template properties:
    - General tab:
      - Template display name: Archive User
    - Request Handling tab:
      - Check: Archive subject’s encryption private key
      - OK prompt if shown
    - Subject Name tab:
      - Clear: E-mail name
      - Clear: Include e-mail name in subject name
    - OK
  - Close templates console

- Back in Certification Authority console:
  - Certificate Templates → New → Certificate Template to Issue
  - Select Archive User → OK
- Close Certification Authority console

## Task 5: Verify key archival + recover key

### Enroll Oscar with Archive User template
- On LON-CL1:
  - Sign in as Contoso\Oscar (Pa55w.rd)
  - Run:
certmgr.msc
  - Certificates - Current User:
    - Personal → right-click Personal → All Tasks → Request New Certificate
    - Next → Next
    - Select Archive User → Enroll → Finish
  - Refresh → Personal → Certificates
  - Confirm Oscar has Archive User certificate

### Simulate loss (delete certificate)
- In certmgr:
  - Right-click Oscar’s new cert → Delete → Yes

### Recover from CA using certutil
- Switch to LON-DC1
- Open Certification Authority console:
  - ContosoCA → Issued Certificates
  - Find cert:
    - Requestor Name: Contoso\Oscar
    - Certificate Template: Archive User
  - Open cert → Details tab → copy Serial number → OK

- Open Command Prompt:
- Run (replace with your copied serial number):
Certutil -getkey <serialnumber> outputblob

  - If pasting serial number:
    - remove spaces OR wrap in quotes "..."

- Verify file exists:
dir

- Convert outputblob to PFX (you’ll be prompted for a password):
Certutil -recoverkey outputblob Oscar.pfx

  - Password: Pa55w.rd
  - Confirm: Pa55w.rd

- Verify Oscar.pfx exists in:
C:\Users\Administrator

- Copy Oscar.pfx to:
C:\Branch1

### Restore on client by importing PFX
- Switch to LON-CL1
- Browse to:
\\LON-DC1.Contoso.com\Branch1

- Right-click Oscar.pfx → Install PFX
  - Next → Next
  - Password: Pa55w.rd
  - Next → Finish → OK

- Open:
certmgr.msc
- Personal → Certificates
- Refresh and verify Oscar’s cert is restored

## Result
- KRA certificate issued
- CA configured for key archival and recovery
- Archive User template archives encryption private keys
- Successful recovery and restoration of Oscar’s certificate/private key
