## EXERCISE 1: CONFIGURING THE AD FS PREREQUISITES

### TASK 1: CONFIGURE DNS FORWARDERS
- [ ] Sign in to LON-DC1 as `Contoso\Administrator` / `Pa55w.rd`
- [ ] Open Server Manager → Tools → DNS
- [ ] Expand LON-DC1 → Conditional Forwarders
- [ ] Right-click Conditional Forwarders → New Conditional Forwarder
- [ ] DNS Domain: TreyResearch.net
- [ ] Master server IP: 172.16.10.10 → Enter
- [ ] Ignore non-authoritative warning if shown
- [ ] Enable: Store this conditional forwarder in Active Directory
- [ ] Replicate to: All DNS servers in this forest → OK
- [ ] Close DNS Manager

- [ ] Switch to TREY-DC1
- [ ] Sign in as `TreyResearch\Administrator` / `Pa55w.rd`
- [ ] Open Server Manager → Tools → DNS
- [ ] Expand TREY-DC1 → Conditional Forwarders
- [ ] Right-click Conditional Forwarders → New Conditional Forwarder
- [ ] DNS Domain: Contoso.com
- [ ] Master server IP: 172.16.0.10 → Enter
- [ ] Ignore non-authoritative warning if shown
- [ ] Enable: Store this conditional forwarder in Active Directory
- [ ] Replicate to: All DNS servers in this forest → OK
- [ ] Close DNS Manager

### TASK 2: CONFIGURE CERTIFICATE TRUSTS
- [ ] Switch to LON-DC1
- [ ] Open File Explorer → `\\TREY-DC1\CertEnroll`
- [ ] Copy `TREY-DC1.TreyResearch.net_TreyResearchCA.crt` to `C:\`
- [ ] Open Server Manager → Tools → Group Policy Management
- [ ] Edit Default Domain Policy
- [ ] Navigate to:
  Computer Configuration → Policies → Windows Settings → Security Settings → Public Key Policies → Trusted Root Certification Authorities
- [ ] Right-click → Import
- [ ] Import: `C:\TREY-DC1.TreyResearch.net_TreyResearchCA.crt`
- [ ] Store: Trusted Root Certification Authorities
- [ ] Finish → OK
- [ ] Close GPMC

- [ ] Switch to TREY-DC1
- [ ] Open File Explorer → `\\LON-DC1\CertEnroll`
- [ ] Right-click `LON-DC1.Contoso.com_ContosoCA.crt` → Install Certificate
- [ ] Store location: Local Machine
- [ ] Store: Trusted Root Certification Authorities
- [ ] Finish → OK

- [ ] Switch to LON-SVR1
- [ ] Sign in as `Contoso\Administrator`
- [ ] Open PowerShell ISE
- [ ] Run: `gpupdate`
- [ ] Close PowerShell ISE

### TASK 3: CONFIGURE SSL CERTIFICATE FOR WEB SERVER
- [ ] On LON-SVR1 open IIS Manager
- [ ] Expand Sites → Default Web Site
- [ ] Actions → Bindings → Add
- [ ] Type: https
- [ ] SSL Certificate: ContosoTestApp Certificate
- [ ] OK → Close IIS Manager

---

## EXERCISE 2: INSTALLING AND CONFIGURING AD FS

### TASK 1: CREATE DNS RECORD FOR AD FS
- [ ] On LON-DC1 open DNS Manager
- [ ] Forward Lookup Zones → Contoso.com
- [ ] New Host (A)
- [ ] Name: adfs
- [ ] IP Address: 172.16.0.10
- [ ] Add Host → OK → Done

### TASK 2: INSTALL AD FS
- [ ] Open PowerShell ISE on LON-DC1
- [ ] Run: `Add-KdsRootKey -EffectiveTime ((Get-Date).AddHours(-10))`
- [ ] Open Server Manager → Add Roles and Features
- [ ] Install: Active Directory Federation Services
- [ ] Complete installation → Close
- [ ] Refresh Server Manager Dashboard

### TASK 3: CONFIGURE AD FS
- [ ] Server Manager → Notifications → Configure federation service
- [ ] Create first federation server
- [ ] Use Contoso\Administrator
- [ ] SSL Certificate: adfs.contoso.com
- [ ] Display Name: Contoso Corporation
- [ ] Create gMSA: ADFSService
- [ ] Database: Windows Internal Database
- [ ] Configure → Close
- [ ] Restart LON-DC1
- [ ] Sign in after reboot

---

## EXERCISE 3: CONFIGURING AN INTERNAL APPLICATION FOR AD FS

### TASK 1: CONFIGURE CLAIMS PROVIDER TRUST
- [ ] Open AD FS Management on LON-DC1
- [ ] Claims Provider Trusts → Active Directory → Edit Claim Rules
- [ ] Add Rule → Send LDAP Attributes as Claims
- [ ] Map:
  - E-Mail-Addresses → E-Mail Address
  - User-Principal-Name → UPN
  - Display-Name → Name
- [ ] Finish → OK

### TASK 2: CONFIGURE APPLICATION TRUST
- [ ] Switch to LON-SVR1
- [ ] Open Windows Identity Foundation Federation Utility
- [ ] Config file: `C:\inetpub\wwwroot\ContosoTestApp\web.config`
- [ ] Application URI: `https://lon-svr1.contoso.com/ContosoTestApp/`
- [ ] STS Metadata: `https://adfs.contoso.com/federationmetadata/2007-06/federationmetadata.xml`
- [ ] Disable cert chain validation
- [ ] No encryption
- [ ] Finish

### TASK 3: CREATE RELYING PARTY TRUST
- [ ] On LON-DC1 PowerShell ISE run:
  `Add-ADFSRelyingPartyTrust -Name 'Contoso Corporation Test App' -MetadataURL 'https://lon-svr1.contoso.com/ContosoTestApp/federationmetadata/2007-06/federationmetadata.xml'`

### TASK 4: CONFIGURE CLAIM RULES
- [ ] Pass through claims:
  - Windows account name
  - E-Mail Address
  - UPN
  - Name
- [ ] Access Control Policy: Permit everyone

### TASK 5: TEST INTERNAL ACCESS
- [ ] On LON-CL1 browse to:
  `https://lon-svr1.contoso.com/ContosoTestApp/`
- [ ] Sign in as `Contoso\Oscar` / `Pa55w.rd`
- [ ] Verify claims displayed

---

## EXERCISE 4: CONFIGURING AD FS FOR FEDERATED BUSINESS PARTNERS

### TASK 1: CREATE DNS RECORD FOR TREY AD FS
- [ ] On TREY-DC1 create A record:
  - Name: adfs
  - IP: 172.16.10.10

### TASK 2: INSTALL & CONFIGURE AD FS (TREY)
- [ ] Run `Add-KdsRootKey -EffectiveTime ((Get-Date).AddHours(-10))`
- [ ] Install AD FS role
- [ ] SSL Certificate: adfs.treyresearch.net
- [ ] Display Name: Trey Research
- [ ] gMSA: ADFSService
- [ ] Restart TREY-DC1

### TASK 3: CONFIGURE CLAIMS PROVIDER TRUST
- [ ] On LON-DC1 run:
  `Add-AdfsClaimsProviderTrust -Name 'Trey Research' -MetadataUrl 'https://adfs.treyresearch.net/federationmetadata/2007-06/federationmetadata.xml'`
- [ ] Disable token binding:
  `Set-AdfsProperties -IgnoreTokenBinding $true`

### TASK 4: CONFIGURE RELYING PARTY TRUST
- [ ] On TREY-DC1 run:
  `Add-ADFSRelyingPartyTrust -Name 'Contoso Corporation' -MetadataURL 'https://adfs.contoso.com/federationmetadata/2007-06/federationmetadata.xml'`
- [ ] Permit everyone initially

### TASK 5: RESTRICT ACCESS TO SALES GROUP
- [ ] Create rule allowing Group = TreyResearch-Sales
- [ ] Send Group Membership as Claim from AD
- [ ] Verify Sales users allowed
- [ ] Verify non-Sales users denied

---

## RESULTS
- [ ] AD FS deployed for Contoso and Trey Research
- [ ] Claims-based SSO functional
- [ ] Federation trust established
- [ ] Group-based authorization enforced
    