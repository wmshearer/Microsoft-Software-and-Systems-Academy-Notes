## EXERCISE 1: CONFIGURING THE AD FS PREREQUISITES

## TASK 1: CONFIGURE THE DNS FORWARDERS

- [ ] Sign in to LON-DC1 as `Contoso\Administrator` / `Pa55w.rd`.
- [ ] Server Manager starts automatically.
- [ ] In the Server Manager window, select Tools, and then select DNS.
- [ ] In DNS Manager, expand LON-DC1, and then select Conditional Forwarders.
- [ ] Right-click or access the context menu for Conditional Forwarders, and then select New Conditional Forwarder.
- [ ] In the New Conditional Forwarder window, in the DNS Domain box, enter TreyResearch.net.
- [ ] In the IP addresses of the master servers box, enter 172.16.10.10, and then select Enter.
- [ ] If you receive a notification that the IP address isn't authoritative for the required zone, you can safely ignore and proceed.
- [ ] Select the Store this conditional forwarder in Active Directory, and replicate it as follows check box, select All DNS servers in this forest, and then select OK.
- [ ] Close DNS Manager.

- [ ] Switch to TREY-DC1.
- [ ] Sign in to TREY-DC1 as `TreyResearch\Administrator` / `Pa55w.rd`.
- [ ] In the Server Manager window, select Tools, and then select DNS.
- [ ] In DNS Manager, expand TREY-DC1, and then select Conditional Forwarders.
- [ ] Right-click or access the context menu for Conditional Forwarders, and then select New Conditional Forwarder.
- [ ] In the New Conditional Forwarder window, in the DNS Domain box, enter Contoso.com.
- [ ] In the IP addresses of the master servers box, enter 172.16.0.10, and then select Enter.
- [ ] If you receive a notification that the IP address isn't authoritative for the required zone, you can safely ignore and proceed.
- [ ] Select the Store this conditional forwarder in Active Directory, and replicate it as follows check box, select All DNS servers in this forest, and then select OK.
- [ ] Close DNS Manager.
- [ ] In a real production environment, you'll probably use Internet DNS instead of conditional forwarders.

## TASK 2: CONFIGURE THE CERTIFICATE TRUSTS

- [ ] Switch to LON-DC1.
- [ ] On LON-DC1, open File Explorer, browse to `\\TREY-DC1\CertEnroll`, and then copy `TREY-DC1.TreyResearch.net_TreyResearchCA.crt` to `C:\`.
- [ ] Close File Explorer.
- [ ] In Server Manager, select Tools, and then select Group Policy Management.
- [ ] In Group Policy Management, expand Forest: Contoso.com, expand Domains, expand Contoso.com, right-click or access the context menu for Default Domain Policy, and then select Edit.
- [ ] In the Group Policy Management Editor, under Computer Configuration, expand Policies, expand Windows Settings, expand Security Settings, expand Public Key Policies, and then select Trusted Root Certification Authorities.
- [ ] Right-click or access the context menu for Trusted Root Certification Authorities, and then select Import.
- [ ] In the Certificate Import Wizard, on the Welcome to the Certificate Import Wizard page, select Next.
- [ ] On the File to Import page, enter `C:\TREY-DC1.TreyResearch.net_TreyResearchCA.crt`, and then select Next.
- [ ] On the Certificate Store page, select Place all certificates in the following store, select Trusted Root Certification Authorities, and then select Next.
- [ ] On the Completing the Certificate Import Wizard page, select Finish, and then select OK to close the success message.
- [ ] Close the Group Policy Management Editor, and then close Group Policy Management.

- [ ] Switch to TREY-DC1.
- [ ] On TREY-DC1, open File Explorer, and then browse to `\\LON-DC1\CertEnroll`.
- [ ] Right-click or access the context menu for `LON-DC1.Contoso.com_ContosoCA.crt`, and then select Install Certificate.
- [ ] In the Certificate Import Wizard, on the Welcome to the Certificate Import Wizard page, select Local Machine, and then select Next.
- [ ] On the Certificate Store page, select Place all certificates in the following store, and then select Browse.
- [ ] In the Select Certificate Store window, select Trusted Root Certification Authorities, and then select OK.
- [ ] On the Certificate Store page, select Next.
- [ ] On the Completing the Certificate Import Wizard page, select Finish, and then select OK to close the success message.
- [ ] Close File Explorer.

- [ ] Switch to LON-SVR1.
- [ ] Sign in to LON-SVR1 as `Contoso\Administrator` / `Pa55w.rd`.
- [ ] On LON-SVR1, select Start and then select Windows PowerShell ISE.
- [ ] At the Windows PowerShell ISE command prompt, enter `gpupdate`, and then select Enter.
- [ ] Close Windows PowerShell ISE.
- [ ] If you obtain certificates from a trusted certification authority (CA), you don't need to configure a certificate trust between the organizations.

## TASK 3: CONFIGURE AN SSL CERTIFICATE FOR THE WEB SERVER

- [ ] On LON-SVR1, open Server Manager, select Tools, and then select Internet Information Services (IIS) Manager.
- [ ] In IIS Manager, expand LON-SVR1 (Contoso\Administrator), expand Sites, select Default Web Site, and then in the Actions pane, select Bindings.
- [ ] In the Site Bindings window, select Add.
- [ ] In the Add Site Binding window, in the Type list, select https.
- [ ] In the SSL certificate list, select ContosoTestApp Certificate, and then select OK.
- [ ] The ContosoTestApp Certificate has been precreated for this lab.
- [ ] In the Site Bindings window, select Close.
- [ ] Close IIS Manager.

- [ ] Results: After completing this exercise, you'll have enabled DNS resolution and certificate trusts between the domains successfully and enabled an SSL certificate for the website.

------------------------------------------------------------

## EXERCISE 2: INSTALLING AND CONFIGURING AD FS

## TASK 1: CREATE A DNS RECORD FOR AD FS

- [ ] On LON-DC1, in Server Manager, select Tools, and then select DNS.
- [ ] In DNS Manager, expand LON-DC1, expand Forward Lookup Zones, and then select Contoso.com.
- [ ] Right-click or access the context menu for Contoso.com, and then select New Host (A or AAAA).
- [ ] In the New Host window, in the Name box, enter adfs.
- [ ] In the IP address box, enter 172.16.0.10, and then select Add Host.
- [ ] In the DNS window, select OK.
- [ ] Select Done, and then close DNS Manager.

## TASK 2: INSTALL AD FS

- [ ] On LON-DC1, select Start, and then select Windows PowerShell ISE.
- [ ] At the command prompt, enter the following command, and then select Enter:
- [ ] `Add-KdsRootKey -EffectiveTime ((Get-Date).AddHours(-10))`
- [ ] This command creates the Microsoft Group Key Distribution Service root key to generate group Managed Service Account (gMSA) passwords for the account that you'll use later in this lab.
- [ ] You should receive a globally unique identifier (GUID) as a response to this command.

- [ ] Select Start, select Server Manager, select Manage, and then select Add Roles and Features.
- [ ] In the Add Roles and Features Wizard, on the Before you begin page, select Next.
- [ ] On the Select installation type page, select Role-based or feature-based installation, and then select Next.
- [ ] On the Select destination server page, select Select a server from the server pool, select LON-DC1.Contoso.com, and then select Next.
- [ ] On the Select server roles page, select the Active Directory Federation Services check box, and then select Next.
- [ ] On the Select features page, select Next.
- [ ] On the Active Directory Federation Services (AD FS) page, select Next.
- [ ] On the Confirm installation selections page, select Install.
- [ ] When the installation is complete, select Close.
- [ ] Select the Refresh Dashboard button to refresh the Server Manager Dashboard.

## TASK 3: CONFIGURE AD FS

- [ ] On LON-DC1, in Server Manager, select the Notifications icon, and then select Configure the federation service on this server.
- [ ] In the Active Directory Federation Services Configuration Wizard, on the Welcome page, select Create the first federation server in a federation server farm, and then select Next.
- [ ] On the Connect to Active Directory Domain Services page, select Next to use Contoso\Administrator to perform the configuration.
- [ ] On the Specify Service Properties page, in the SSL Certificate list, select adfs.contoso.com.
- [ ] In the Federation Service Display Name box, enter Contoso Corporation, and then select Next.
- [ ] On the Specify Service Account page, select Create a Group Managed Service Account.
- [ ] In the Account Name box, enter ADFSService, and then select Next.
- [ ] On the Specify Configuration Database page, select Create a database on this server using Windows Internal Database, and then select Next.
- [ ] On the Review Options page, select Next.
- [ ] On the Pre-requisite Checks page, select Configure.
- [ ] On the Results page, select Close.
- [ ] The adfs.Contoso.com certificate was preconfigured for this task. In your own environment, you must obtain this certificate.
- [ ] Restart LON-DC1.
- [ ] After the server restarts, sign in as Contoso\Administrator with the password of Pa55w.rd.
- [ ] Results: After completing this exercise, you should have successfully installed and configured AD FS.

------------------------------------------------------------

## EXERCISE 3: CONFIGURING AN INTERNAL APPLICATION FOR AD FS

## TASK 1: CONFIGURE THE ACTIVE DIRECTORY CLAIMS PROVIDER TRUST

- [ ] On LON-DC1, in Server Manager, select Tools, and then select AD FS Management.
- [ ] It may take a minute or two for the AD FS service to start. If an error message is displayed, wait a minute and then retry.
- [ ] In the AD FS management console, select Claims Provider Trusts.
- [ ] In the list of Claims Provider Trusts, right-click or access the context menu for Active Directory, and then select Edit Claim Rules.
- [ ] In the Edit Claims Rules for Active Directory window, on the Acceptance Transform Rules tab, select Add Rule.
- [ ] In the Add Transform Claim Rule Wizard, on the Select Rule Template page, in the Claim rule template list, select Send LDAP Attributes as Claims, and then select Next.
- [ ] On the Configure Rule page, in the Claim rule name box, enter Outbound LDAP Attributes Rule.
- [ ] In the Attribute store list, select Active Directory.
- [ ] In the Mapping of LDAP attributes to outgoing claim types section, select the following values for the LDAP Attribute and the Outgoing Claim Type, and then select Finish:
- [ ] E-Mail-Addresses: E-Mail Address
- [ ] User-Principal-Name: UPN
- [ ] Display-Name: Name
- [ ] In the Edit Claim Rules for Active Directory window, select OK.

## TASK 2: CONFIGURE THE APPLICATION TO TRUST INCOMING CLAIMS

- [ ] Switch to LON-SVR1.
- [ ] On LON-SVR1, open Server Manager, select Tools, and then select Windows Identity Foundation Federation Utility.
- [ ] On the Welcome to the Federation Utility Wizard page, in the Application configuration location box, enter:
- [ ] `C:\inetpub\wwwroot\ContosoTestApp\web.config`
- [ ] In the Application URI box, enter:
- [ ] `https://lon-svr1.Contoso.com/ContosoTestApp/`
- [ ] Select Next.
- [ ] On the Security Token Service page, select Use an existing STS.
- [ ] In the STS WS-Federation metadata document location box, enter:
- [ ] `https://adfs.Contoso.com/federationmetadata/2007-06/federationmetadata.xml`
- [ ] Select Next.
- [ ] On the STS signing certificate chain validation error page, select Disable certificate chain validation, and then select Next.
- [ ] On the Security token encryption page, select No encryption, and then select Next.
- [ ] On the Offered claims page, review the claims that will be offered by the federation server, and then select Next.
- [ ] On the Summary page, review the changes, scroll through the items to understand what each item is doing, and then select Finish.
- [ ] In the Success window, select OK.

## TASK 3: CONFIGURE A RELYING PARTY TRUST FOR THE CLAIMS-AWARE APPLICATION

- [ ] Switch to LON-DC1.
- [ ] On LON-DC1, open Windows PowerShell ISE.
- [ ] Run:
- [ ] `Add-ADFSRelyingPartyTrust -Name 'Contoso Corporation Test App' -MetadataURL 'https://lon-svr1.Contoso.com/ContosoTestApp/federationmetadata/2007-06/federationmetadata.xml'`

## TASK 4: CONFIGURE CLAIM RULES FOR THE RELYING PARTY TRUST

- [ ] On LON-DC1, in the AD FS management console, select Relying Party Trusts.
- [ ] Select Contoso Corporation Test App → Edit Claim Issuance Policy.
- [ ] On Issuance Transform Rules tab → Add Rule:
- [ ] Template: Pass Through or Filter an Incoming Claim → Next
- [ ] Rule name: Pass through Windows account name
- [ ] Incoming claim type: Windows account name → Finish
- [ ] Add Rule again:
- [ ] Rule name: Pass through E-Mail Address
- [ ] Incoming claim type: E-Mail Address → Finish
- [ ] Add Rule again:
- [ ] Rule name: Pass through UPN
- [ ] Incoming claim type: UPN → Finish
- [ ] Add Rule again:
- [ ] Rule name: Pass through Name
- [ ] Incoming claim type: Name → Finish
- [ ] Select OK.

- [ ] In the AD FS management console, select Contoso Corporation Test App → Edit Access Control Policy.
- [ ] Select Permit everyone → OK.

## TASK 5: TEST ACCESS TO THE CLAIMS-AWARE APPLICATION

- [ ] Switch to LON-CL1.
- [ ] Sign in as `Contoso\Administrator` / `Pa55w.rd`.
- [ ] Open Microsoft Edge.
- [ ] Browse to: `https://lon-svr1.Contoso.com/ContosoTestApp/`
- [ ] Be sure to include the trailing forward slash (/) in the URL.
- [ ] In the Sign In window, sign in as `Contoso\Oscar` / `Pa55w.rd`.
- [ ] Review the claim information displayed by the application.
- [ ] Close Microsoft Edge.
- [ ] Results: AD FS configured successfully to support application authentication.

------------------------------------------------------------

## EXERCISE 4: CONFIGURING AD FS FOR FEDERATED BUSINESS PARTNERS

## TASK 1: CREATE A DNS RECORD FOR AD FS AT TREY RESEARCH

- [ ] On TREY-DC1, in Server Manager, select Tools, and then select DNS.
- [ ] Expand TREY-DC1 → Forward Lookup Zones → TreyResearch.net.
- [ ] Right-click TreyResearch.net → New Host (A or AAAA).
- [ ] Name: adfs
- [ ] IP address: 172.16.10.10
- [ ] Add Host → OK → Done → Close DNS Manager.

## TASK 2: INSTALL AD FS FOR TREY RESEARCH

- [ ] On TREY-DC1, open Windows PowerShell ISE.
- [ ] Run:
- [ ] `Add-KdsRootKey -EffectiveTime ((Get-Date).AddHours(-10))`
- [ ] You should receive a GUID response.

- [ ] Open Server Manager → Manage → Add Roles and Features.
- [ ] Role-based or feature-based installation → Next
- [ ] Select TREY-DC1.TreyResearch.net → Next
- [ ] Select Active Directory Federation Services → Next
- [ ] Select features → Next
- [ ] AD FS page → Next
- [ ] Install → Close
- [ ] Refresh Dashboard.

## TASK 3: CONFIGURE AD FS FOR TREY RESEARCH

- [ ] Server Manager → Notifications → Configure the federation service on this server.
- [ ] Create the first federation server in a federation server farm → Next
- [ ] Use TreyResearch\Administrator → Next
- [ ] SSL certificate: adfs.treyresearch.net (preconfigured)
- [ ] Display name: Trey Research → Next
- [ ] Create Group Managed Service Account:
- [ ] Account Name: ADFSService → Next
- [ ] Create database using Windows Internal Database → Next
- [ ] Review → Next
- [ ] Pre-req checks → Configure
- [ ] Results → Close
- [ ] Restart TREY-DC1.
- [ ] After restart sign in as `TreyResearch\Administrator` / `Pa55w.rd`.

## TASK 4: CONFIGURE CLAIMS PROVIDER TRUST FOR TREY AD FS (ON CONTOSO)

- [ ] Switch to LON-DC1.
- [ ] In PowerShell ISE run:
- [ ] `Add-AdfsClaimsProviderTrust -Name 'Trey Research' -MetadataUrl 'https://adfs.treyresearch.net/federationmetadata/2007-06/federationmetadata.xml'`
- [ ] If AD FS service isn't started yet, wait 1–2 minutes and retry.
- [ ] Disable token binding (compatibility issues with Edge):
- [ ] `Set-AdfsProperties -IgnoreTokenBinding $true`

- [ ] Open AD FS Management console.
- [ ] Claims Provider Trusts → right-click Trey Research → Edit Claim Rules…
- [ ] (You may need to Refresh Claims Provider Trusts first.)
- [ ] Acceptance Transform Rules tab → Add Rule
- [ ] Template: Pass Through or Filter an Incoming Claim → Next
- [ ] Rule name: Pass through Windows account name
- [ ] Incoming claim type: Windows account name
- [ ] Pass through all claim values → Finish
- [ ] Acknowledge warning → Yes
- [ ] OK → Close AD FS Management console.

## TASK 5: CONFIGURE RELYING PARTY TRUST FOR CONTOSO APP (ON TREY)

- [ ] On TREY-DC1 open PowerShell ISE.
- [ ] Run:
- [ ] `Add-ADFSRelyingPartyTrust -Name 'Contoso Corporation' -MetadataURL 'https://adfs.Contoso.com/federationmetadata/2007-06/federationmetadata.xml'`

- [ ] Server Manager → Tools → AD FS Management.
- [ ] Relying Party Trusts → select Contoso Corporation
- [ ] Actions → Edit Claim Issuance Policy
- [ ] Add Rule → Template: Pass Through or Filter an Incoming Claim → Next
- [ ] Rule name: Pass through Windows account name
- [ ] Incoming claim type: Windows account name
- [ ] Pass through all claim values → Finish → OK → OK
- [ ] Edit Access Control Policy → Permit everyone → OK
- [ ] Close AD FS Management.

## TASK 6: VERIFY ACCESS TO THE WEBSITE

- [ ] On TREY-DC1 click Start → Internet Options → Enter
- [ ] Privacy tab → Sites
- [ ] Address of website: Contoso.com → Allow → OK → OK

- [ ] Open Microsoft Edge
- [ ] Browse to: `https://lon-svr1.Contoso.com/Contosotestapp/`
- [ ] On Contoso Corporation page select Trey Research
- [ ] If “This page cannot be displayed” appears → Refresh and retry
- [ ] Sign in as `TreyResearch\Connie` / `Pa55w.rd`
- [ ] After app loads → close Edge

- [ ] Open Edge again
- [ ] Browse again to: `https://lon-svr1.Contoso.com/Contosotestapp/`
- [ ] Sign in as `TreyResearch\Connie` / `Pa55w.rd`
- [ ] Close Edge

- [ ] Note: You aren’t prompted for home realm on the second access because an _LSRealm cookie is created (default lifetime 30 days). Delete the cookie between sign-in attempts to return to a clean state.

## TASK 7: CONFIGURE GROUP RESTRICTIONS (ALLOW ONLY SALES)

- [ ] On TREY-DC1 open AD FS Management.
- [ ] Relying Party Trusts → right-click Contoso Corporation → Edit Claim Issuance Policy
- [ ] Issuance Transform Rules tab → Remove Rule → Yes
- [ ] Add Rule
- [ ] Template: Pass Through or Filter an Incoming Claim → Next
- [ ] Rule name: Allow Sales Members
- [ ] Incoming claim type: Group
- [ ] Select: Pass through only a specific claim value
- [ ] Incoming claim value: TreyResearch-Sales
- [ ] Finish → OK

- [ ] In AD FS Management → Claims Provider Trusts
- [ ] Right-click Active Directory → Edit Claim Rules
- [ ] Add Rule
- [ ] Template: Send Group Membership as a Claim → Next
- [ ] Rule name: Sales Group Claim
- [ ] Browse → enter Sales → OK
- [ ] Outgoing claim type: Group
- [ ] Outgoing claim value: TreyResearch-Sales
- [ ] Finish → OK
- [ ] Close AD FS Management

## TASK 8: VERIFY ACCESS WITH GROUP RESTRICTIONS

- [ ] On TREY-DC1 open Microsoft Edge
- [ ] Browse to: `https://lon-svr1.Contoso.com/Contosotestapp/`
- [ ] Sign in as `TreyResearch\Allan` / `Pa55w.rd`
- [ ] Verify Allan can access the application
- [ ] Close Microsoft Edge

- [ ] Results: After completing this exercise, you should have successfully configured access for a claims-aware application in a partner organization.
