## LAB A: IMPLEMENT A WEB APPLICATION PROXY

### Lab Scenario
A partner organization needs access to a single internal web app at Contoso. External users must **only** access that app and **nothing else** internally. You will deploy and test **Web Application Proxy (WAP)**.

------------------------------------------------------------

## EXERCISE 1: IMPLEMENT WEB APPLICATION PROXY

### Scenario
Deploy Web Application Proxy as a proof of concept (pass-through now; later developers will move the app to AD FS claims-based authentication).

### Main tasks
- Prepare the environment
- Configure LON-CL1 as an external client
- Install Web Application Proxy role service
- Configure access to an internal website

------------------------------------------------------------

### Task 1: Prepare the environment

#### Disable Routing and Remote Access on EU-RTR
1. Sign in to **EU-RTR** as `Contoso\Administrator` / `Pa55w.rd`.
2. Open **Server Manager**.
3. Go to **Tools** → **Routing and Remote Access**.
4. In the left pane, right-click **EU-RTR (local)** → select **Disable Routing and Remote Access**.
5. In the prompt, select **Yes**.
6. Close the Routing and Remote Access window.

> NOTE: RRAS is preconfigured for other labs. WAP will not work properly if RRAS remains enabled on EU-RTR.

------------------------------------------------------------

### Task 2: Configure LON-CL1 as an external client

#### A) Remove the client computer from the domain
1. Sign in to **LON-CL1** as `Contoso\Administrator` / `Pa55w.rd`.
2. Right-click **Start** → select **System**.
3. Select **Advanced system settings**.
4. Select the **Computer Name** tab.
5. Select **Change**.
6. Select **Workgroup**, enter `WORKGROUP`, then select **OK**.
7. Select **OK** again.
8. In the “Welcome to the WORKGROUP workgroup” message, select **OK**.
9. Select **OK** to restart.
10. Select **Close** on System Properties.
11. Select **Restart Now** and wait for the restart.

#### B) Import a root CA certificate on the client
1. Sign in to **LON-CL1** as `Admin` / `Pa55w.rd`.
2. Open **File Explorer**.
3. In the address bar, enter `\\172.16.0.10\C$` and press **Enter**.
4. When prompted for credentials:
   - User: `Contoso\Administrator`
   - Password: `Pa55w.rd`
5. Locate `ContosoRootCA.cer`.
6. Right-click `ContosoRootCA.cer` → **Show more options** → **Install Certificate**.
7. In **Open File - Security Warning**, select **Open**.
8. On the wizard welcome page:
   - Select **Local Machine**
   - Select **Next**
9. If prompted by UAC, select **Yes**.
10. Select **Place all certificates in the following store** → **Browse**.
11. Select **Trusted Root Certification Authorities** → **OK**.
12. Select **Next** → **Finish**.
13. Select **OK**.

#### C) Verify the certificate is installed in Trusted Root CA store
1. Right-click **Start** → select **Windows Terminal**.
2. Run:
   - `mmc`
3. If prompted by UAC, select **Yes**.
4. In MMC: **File** → **Add/Remove Snap-in**.
5. Select **Certificates** → **Add**.
6. Select **Computer account** → **Next**.
7. Select **Finish** → **OK**.
8. Expand:
   - **Certificates**
   - **Trusted Root Certification Authorities**
   - **Certificates**
9. Verify **ContosoCA** exists.
10. Close MMC **without saving**.

> NOTE: This makes LON-CL1 trust certificates issued by the Contoso CA.

#### D) Move the computer to the internet
1. On **LON-CL1**, right-click **Start** → select **Network Connections**.
2. Select **Advanced network settings**.
3. Select **More network adapter options**.
4. In Network Connections:
   - Right-click **London_Network** → **Disable**
   - Right-click **Internet** → **Enable**
5. Open **Microsoft Edge**.
6. Browse to `https://lon-svr1.contoso.com`.
7. Confirm a **Network Error** appears.
8. Close all open windows.

> NOTE: You can’t reach the internal site anymore because you moved to the “Internet” network.

------------------------------------------------------------

### Task 3: Install the Web Application Proxy role service

1. Switch to **EU-RTR**.
2. Open **Server Manager**.
3. Select **Add roles and features**.
4. Select **Next** on:
   - Before you begin
   - Select installation type
   - Select destination server
5. On **Select server roles**:
   - Expand **Remote Access**
   - Select **Web Application Proxy**
   - Select **Next**
6. On **Select features**, select **Next**.
7. On **Confirm installation selections**, select **Install**.
8. On **Installation progress**, verify success → select **Close**.

------------------------------------------------------------

### Task 4: Configure access to an internal website

#### A) Obtain a certificate for the ADFSWAP farm
1. On **EU-RTR**, right-click **Start** → select **Windows PowerShell**.
2. Run:
   - `mmc`
3. In MMC: **File** → **Add/Remove Snap-In**.
4. Select **Certificates** → **Add**.
5. Select **Computer account** → **Next**.
6. Verify **Local Computer** → **Finish** → **OK**.
7. Expand **Certificates (Local Computer)**.
8. Right-click **Personal** → **All Tasks** → **Request New Certificate**.
9. **Before You Begin** → **Next**.
10. **Select Certificate Enrollment Policy** → **Next**.
11. Select **Contoso Web Server**.
12. Select: **More information is required to enroll…** (configure settings link).
13. Under **Subject name**:
    - Type: **Common name**
    - Value: `adfswap.contoso.com`
    - Select **Add**
14. Under **Alternative name**:
    - Type: **DNS**
    - Value: `adfswap.contoso.com`
    - Select **Add**
15. Add additional **DNS** alternative names:
    - `rdgw.contoso.com` → **Add**
    - `lon-svr1.contoso.com` → **Add**
16. Select **OK** to close Certificate Properties.
17. Select **Enroll**.
18. Select **Finish**.
19. Close MMC **without saving**.

------------------------------------------------------------

#### B) Configure Web Application Proxy
1. Open **Server Manager** → **Tools** → **Remote Access Management**.
2. In the left pane, select **Web Application Proxy**.
3. Select **Run the Web Application Proxy Configuration Wizard**.
4. On **Welcome**, select **Next**.
5. Federation service name: `adfswap.contoso.com`
6. Credentials:
   - User name: `Administrator`
   - Password: `Pa55w.rd`
7. Select **Next**.
8. On **AD FS Proxy Certificate**, select `adfswap.contoso.com`.
9. Select **Next**.
10. On **Confirmation**, review → select **Configure**.
11. On **Results**, verify success → **Close**.

> If error: verify **LON-SVR2 is running** and **AD FS service is running** on LON-SVR2, then rerun the wizard.

------------------------------------------------------------

#### C) Publish the internal website
1. In **Remote Access Management**, select **Web Application Proxy**.
2. In the **Tasks** pane, select **Publish**.
3. **Welcome** → **Next**.
4. **Preauthentication**: select **Pass-through** → **Next**.
5. **Publishing Settings**:
   - Name: `Contoso LOB Web App (LON-SVR1)`
   - External URL: `https://lon-svr1.contoso.com`
   - External certificate: `adfswap.contoso.com`
   - Backend server URL: confirm `https://lon-svr1.contoso.com`
6. Select **Next**.
7. **Confirmation** → select **Publish**.
8. **Results**: confirm success → **Close**.
9. Close Remote Access Management console.

------------------------------------------------------------

#### D) Configure internal website authentication (IIS)
1. Switch to **LON-SVR1**, sign in as `Contoso\Administrator` / `Pa55w.rd`.
2. Open **Server Manager** → **Tools** → **Internet Information Services (IIS) Manager**.
3. Expand `LON-SVR1 (Contoso\administrator)` → **Sites** → **Default Web Site**.
4. Open **Authentication**.
5. Right-click **Windows Authentication** → **Enable**.
6. Right-click **Anonymous Authentication** → **Disable**.
7. Close IIS Manager.

**Result:** Web Application Proxy is implemented and internal site authentication configured.

------------------------------------------------------------

## EXERCISE 2: VALIDATE THE WEB APPLICATION PROXY DEPLOYMENT

### Scenario
Confirm external users can access the internal app via the proxy.

------------------------------------------------------------

### Task 1: Verify access to the internal website from the client computer

1. Switch to **LON-CL1**.
2. Open **Microsoft Edge**.
3. Browse to `https://lon-svr1.contoso.com`.
4. At the Windows Security prompt:
   - User name: `Contoso\susan`
   - Password: `Pa55w.rd`
5. Select **OK**.
6. Verify the default IIS page for **LON-SVR1** opens.
7. Close Edge.
8. Sign out of **LON-CL1**.

**Result:** External users can access the internal application through Web Application Proxy.

------------------------------------------------------------

If you want, paste **Lab B (VPN)** next and I’ll format it the same way.

## LAB B: IMPLEMENT A VPN

### Lab Scenario
Contoso will implement a VPN solution based on **SSTP**. You must verify certificate requirements, configure Remote Access (RRAS) for VPN connectivity, and create a Remote Access policy allowing **PPTP + SSTP**.

------------------------------------------------------------

## EXERCISE 1: IMPLEMENT A VPN SOLUTION

### Main tasks
- Verify certificate requirements for IKEv2 and SSTP
- Review the default VPN configuration
- Configure the Remote Access policies

------------------------------------------------------------

### Task 1: Verify certificate requirements for IKEv2 and SSTP

#### A) Prepare the environment (LON-DC1)
1. Sign in to **LON-DC1** as `Contoso\Administrator` / `Pa55w.rd`.
2. Select **Start** → open **Windows PowerShell ISE**.
3. Run:
   `cd E:\Labfiles\Mod06`
4. Run:
   `.\mod6.ps1`
5. Wait for the script to complete (~20 seconds).

#### B) Request a certificate for EU-RTR (EU-RTR)
1. Switch to **EU-RTR**, sign in as `Contoso\Administrator` / `Pa55w.rd`.
2. Select **Start** → search **Command Prompt** → open it.
3. Run:
   `mmc`
4. In MMC: **File** → **Add/Remove Snap-in**.
5. Select **Certificates** → **Add**.
6. Choose **Computer account** → **Next**.
7. Choose **Local computer** → **Finish** → **OK**.
8. In the console tree, go to:
   **Certificates (Local Computer)** → **Personal**
9. Right-click **Personal** → **All Tasks** → **Request New Certificate**.
10. **Before you begin** → **Next**.
11. **Select Certificate Enrollment Policy** → **Next**.
12. Select **Contoso Web Server**.
13. Select **More information is required to enroll for this certificate...** (configure settings link).
14. In **Certificate Properties** → **Subject** tab:
    - Under **Subject name** → Type: **Common name**
    - Value: `131.107.0.10`
    - Select **Add**
15. Select **OK** → select **Enroll** → select **Finish**.
16. In MMC:
    - Expand **Personal** → select **Certificates**
    - Verify a new certificate named `131.107.0.10` exists with **Intended Purposes: Server Authentication**
17. Close MMC.
18. If prompted to save settings, select **No**.

#### C) Change the HTTPS bindings (EU-RTR)
1. On **EU-RTR**, open **Server Manager** → **Tools** → **Internet Information Services (IIS) Manager**.
2. Expand `EU-RTR (Contoso\Administrator)`.
3. Expand **Sites** → select **Default Web Site**.
4. In **Actions**, select **Bindings** → select **Add**.
5. In **Add Site Binding**:
   - Type: **https**
   - SSL certificate: select the `131.107.0.10` certificate
6. Select **OK** → **Close**.
7. Close IIS Manager.

------------------------------------------------------------

### Task 2: Review the default VPN configuration (EU-RTR)

1. On **EU-RTR**, open **Server Manager** → **Tools** → **Routing and Remote Access**.
2. Right-click **EU-RTR (local)** → **Configure and Enable Routing and Remote Access**.
3. Wizard:
   - **Welcome** → **Next**
   - **Configuration** → select **Custom configuration** → **Next**
   - **Custom Configuration** → select **VPN access** and **LAN routing** → **Next**
   - **Completing** → **Finish**
4. When prompted, select **Start service**.

#### Configure ports
5. Expand **EU-RTR (local)**.
6. Right-click **Ports** → **Properties**.
7. Verify ports exist for:
   - **SSTP**
   - **IKEv2**
   - **PPTP**
   - **L2TP**
8. Open **WAN Miniport (SSTP)**:
   - Set **Maximum ports** to `4`
   - Select **OK**
9. In the message box, select **Yes**.
10. Repeat steps 8–9 for:
   - **IKEv2**
   - **PPTP**
   - **L2TP**
11. Select **OK** to close **Ports Properties**.

#### Configure RRAS server properties
12. Right-click **EU-RTR (local)** → **Properties**.
13. **General** tab: verify **IPv4 Remote access server** is selected.
14. **Security** tab:
    - Certificate dropdown: select `131.107.0.10`
15. Select **Authentication Methods**:
    - Verify **EAP** is selected
    - Select **OK**
16. **IPv4** tab:
    - Verify IPv4 addressing is assigned using **DHCP**
17. Adapter dropdown:
    - Select `London_Network`
18. Select **OK**.
19. If prompted, select **Yes**.

------------------------------------------------------------

### Task 3: Configure the Remote Access policies (EU-RTR)

1. On **EU-RTR**, open **Server Manager** → **Tools** → **Network Policy Server**.
2. Expand **Policies** → select **Network Policies**.
3. Right-click **Network Policies** → **New**.
4. Policy name: `Contoso IT VPN`
5. Type of network access server: **Remote Access Server (VPN-Dial up)** → **Next**
6. **Specify Conditions** → select **Add**
7. Select condition: **Windows Groups** → **Add**
8. In **Windows Groups** dialog → **Add Groups**
9. In **Select Group**:
   - Enter `IT`
   - Select **Check Names**
   - Select **OK**
10. Select **OK** → **Next**
11. **Specify Access Permission**:
   - Verify **Access granted**
   - Select **Next**
12. **Configure Authentication Methods**:
   - Clear **Microsoft Encrypted Authentication (MS-CHAP)** check box
13. Add EAP types:
   - Select **Add**
   - Choose **Microsoft Secured password (EAP-MSCHAP v2)** → **OK**
14. Add EAP types again:
   - Select **Add**
   - Choose **Microsoft: Smart Card or other certificate** → **OK**
15. Select **Next**
16. **Configure Constraints** → **Next**
17. **Configure Settings** → **Next**
18. **Completing New Network Policy** → **Finish**
19. Close all open windows.

**Result:** EU-RTR VPN server + policy are configured for VPN connectivity.

------------------------------------------------------------

## EXERCISE 2: VALIDATE THE VPN DEPLOYMENT

### Main tasks
- Validate that LON-CL1 is an external client
- Configure a VPN connection, then verify connectivity (PPTP then SSTP)

------------------------------------------------------------

### Task 1: Validate that LON-CL1 is an external client

1. Switch to **LON-CL1**, sign in as `Admin` / `Pa55w.rd`.
2. Right-click **Start** → **Network Connections**.
3. Select **Advanced network settings**.
4. Select **More network adapter options**.
5. Verify:
   - `London_Network` is **disabled**
   - `Internet` is **enabled**
6. Right-click **Internet** → **Properties**.
7. Open **Internet Protocol Version 4 (TCP/IPv4)**.
8. Verify these settings, then select **OK**:
   - IP address: `131.107.0.20`
   - Subnet mask: `255.255.255.0`
   - Preferred DNS server: `131.107.0.100`
9. Select **Cancel** to close Internet Properties.
10. Close all open windows.
11. Open **File Explorer**.
12. In the address bar, enter `\\LON-DC1\` → press **Enter**.
13. Confirm a **Network Error** appears.
14. Close all open windows.

------------------------------------------------------------

### Task 2: Configure a VPN connection and verify connectivity

#### A) Create a VPN profile, then connect using PPTP
1. On **LON-CL1**, open **Settings**.
2. Select **Network & internet** → **VPN**.
3. Next to **VPN connections**, select **Add VPN**.
4. Configure:
   - VPN provider: **Windows (built-in)**
   - Connection name: `Contoso VPN`
   - Server name or address: `131.107.0.10`
   - VPN type: **Point to Point Tunneling Protocol (PPTP)**
   - Type of sign-in info: **User name and password**
   - Deselect: **Remember my sign-in info**
5. Select **Save**.
6. On the VPN page, next to `Contoso VPN`, select **Connect**.
7. Sign in:
   - User name: `Contoso\Tonnie`
   - Password: `Pa55w.rd`
   - Select **OK**
8. Verify adapter appears:
   - Start → type `Network Connections`
   - Select **View network connections**
   - Confirm **WAN Miniport (PPTP)** displays under `Contoso VPN`

#### B) Connect to a VPN by using SSTP
1. In **Network Connections**, right-click `Contoso VPN` → **Properties**.
2. Select the **Security** tab.
3. In **Type of VPN**, select **Secure Socket Tunneling Protocol (SSTP)**.
4. Ensure **Use Extensible Authentication Protocol (EAP)** is selected.
5. Select **OK** twice.
6. Open `Contoso VPN` → select **Disconnect**.
7. Open `Contoso VPN` again.
8. In quick settings:
   - Select **VPN**
   - Select `Contoso VPN`
   - Select **Connect**
9. Sign in:
   - User name: `Contoso\Tonnie`
   - Password: `Pa55w.rd`
   - Select **OK**
10. Verify the connection is established using **SSTP**.
11. Open `Contoso VPN` → select **Disconnect**.
12. Sign out of **LON-CL1**.

**Result:** Clients can connect using VPN (PPTP + SSTP).

------------------------------------------------------------

## EXERCISE 3: TROUBLESHOOT VPN ACCESS

### Scenario
Tonnie reports she suddenly can’t connect to Contoso VPN from home. You will simulate the issue, document the error, implement the fix, and retest.

------------------------------------------------------------

### Task 1: Read the help-desk incident record (IN24578)
1. Review the incident details and additional info for **IN24578** in the lab scenario.

------------------------------------------------------------

### Task 2: Update the Plan of Action section of the incident record
1. Use the Additional Information and your troubleshooting steps to write recommendations in the **Plan of Action** section.
2. (You’ll also record the exact error message after you reproduce the issue.)

------------------------------------------------------------

### Task 3: Simulate the issue, then try to connect (LON-CL1)

1. Sign in to **LON-CL1** as `Admin` / `Pa55w.rd`.
2. Right-click **Start** → **Windows Terminal (Admin)**.
3. If prompted by UAC, select **Yes**.
4. Run:
   `cd C:\Labfiles\Mod06\`
5. Run:
   `.\Mod6LabB.ps1`
6. Wait for the script to complete.
7. Select **Start** → type `Network Connections` → select **View network connections**.
8. Open `Contoso VPN`.
9. In quick settings:
   - Select **VPN**
   - Select `Contoso VPN`
   - Select **Connect**
10. Wait for the connection attempt to fail.
11. Record the **exact error message** in the incident record’s Plan of Action.
12. If it connects successfully, disconnect and try again (it should fail).

------------------------------------------------------------

### Task 4: Implement the fix, then test (LON-CL1)

#### A) Re-import the Root CA certificate (Trusted Root)
1. Open **File Explorer**.
2. In the address bar, enter `\\172.16.0.10\C$\` → press **Enter**.
3. In Windows Security prompt:
   - User: `Contoso\Administrator`
   - Password: `Pa55w.rd`
4. Right-click `ContosoRootCA.cer` → **Show more options** → **Install Certificate**.
5. In **Open File - Security Warning**, select **Open**.
6. Wizard:
   - Select **Local Machine** → **Next**
7. If prompted by UAC, select **Yes**.
8. Select **Place all certificates in the following store** → **Browse**.
9. Select **Trusted Root Certification Authorities** → **OK**.
10. Select **Next** → **Finish**.
11. Wait ~15 seconds for import to complete.
12. Select **OK**.

#### B) Verify ContosoCA exists in Trusted Root (MMC)
1. Right-click **Start** → open **Windows Terminal**.
2. Run:
   `mmc`
3. If prompted by UAC, select **Yes**.
4. In MMC: **File** → **Add/Remove Snap-in**.
5. Select **Certificates** → **Add**.
6. Select **Computer account** → **Next** → **Finish** → **OK**.
7. Expand:
   - **Certificates**
   - **Trusted Root Certification Authorities**
   - **Certificates**
8. Verify **ContosoCA** exists.

#### C) Re-test VPN connectivity
1. Open quick settings → select **VPN** → select `Contoso VPN` → **Connect**.
2. Sign in:
   - User name: `Contoso\Tonnie`
   - Password: `Pa55w.rd`
3. Verify you can connect to the Contoso VPN server.
4. Disconnect from `Contoso VPN`.
5. Sign out of **LON-CL1**.

**Result:** VPN access issue is resolved and Tonnie can connect again.
