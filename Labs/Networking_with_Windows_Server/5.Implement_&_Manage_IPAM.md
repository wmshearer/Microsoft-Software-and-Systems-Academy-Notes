## LAB: IMPLEMENT IPAM

### Lab Scenario
Contoso’s network spans multiple locations and has become complex to manage. To centrally manage IP addressing, DHCP, and DNS services, you will deploy **IP Address Management (IPAM)** and use it to monitor and manage the environment.

------------------------------------------------------------

## EXERCISE 1: INSTALL THE IPAM SERVER FEATURE

### Scenario
You will install the IPAM Server feature on **LON-SVR2** and prepare the lab environment.

------------------------------------------------------------

### Task 1: Prepare the lab environment

> ⚠️ The following scripts generate warnings — this is expected. Ignore them.

1. Sign in to **LON-SVR1** as `Contoso\Administrator` / `Pa55w.rd`.
2. Open **Windows PowerShell ISE**.
3. Run:
   - `C:\Labfiles\Mod05\LON-SVR1_Mod05_Setup.ps1`

4. Sign in to **TOR-SVR1** as `Contoso\Administrator` / `Pa55w.rd`.
5. Open **Windows PowerShell ISE**.
6. Run:
   - `C:\Labfiles\Mod05\TOR-SVR1_Mod05_Setup.ps1`

7. Sign in to **SYD-SVR1** as `Contoso\Administrator` / `Pa55w.rd`.
8. Open **Windows PowerShell ISE**.
9. Run:
   - `C:\Labfiles\Mod05\SYD-SVR1_Mod05_Setup.ps1`

10. **SYD-SVR1 will restart automatically**.
11. After restart, sign back in as `Contoso\Administrator` / `Pa55w.rd`.

------------------------------------------------------------

### Task 2: Install the IPAM Server feature on LON-SVR2

1. Sign in to **LON-SVR2** as `Contoso\Administrator` / `Pa55w.rd`.
2. Open **Server Manager** → **Add roles and features**.
3. Select **Next** until the **Select features** page.
4. Select **IP Address Management (IPAM) Server**.
5. When prompted, select **Add Features** → **Next**.
6. On **Confirm installation selections**, select **Install**.
7. When installation completes, close the wizard.

**Result:** IPAM Server feature is installed.

------------------------------------------------------------

## EXERCISE 2: PROVISION THE IPAM SERVER

### Scenario
You will configure IPAM to discover and manage DHCP, DNS, and DC servers in the Contoso.com domain.

Managed servers:
- **LON-DC1** (DC, DHCP, DNS)
- **LON-SVR1** (DHCP, DNS)
- **TOR-SVR1** (DHCP)
- **SYD-SVR1** (DC, DNS)

------------------------------------------------------------

### Task 1: Configure IPAM for GPO-based provisioning

1. On **LON-SVR2**, open **Server Manager** → **IPAM**.
2. Select **Connect to IPAM server** → choose `LON-SVR2.Contoso.com` → **OK**.
3. Select **Provision the IPAM server**.
4. Select **Next**.
5. On **Configure database**, ensure **Windows Internal Database (WID)** is selected → **Next**.
6. Select **Group Policy Based** provisioning.
7. In **GPO name prefix**, enter `IPAM`.
8. Select **Next** → **Apply**.

> If provisioning fails due to WID:
> - Open `services.msc`
> - Restart **Windows Internal Database**
> - Repeat the provisioning steps

9. Select **Close** when provisioning completes.

------------------------------------------------------------

### Task 2: Perform server discovery

1. In the **IPAM Overview** pane, select **Configure server discovery**.
2. Select **Get forests** → **OK**.
3. Select **Configure server discovery** again.
4. Select **Add**, choose **Contoso.com**, select **OK**.
5. Select **Start server discovery**.

> ⏳ Discovery may take **5–10 minutes**  
> Use **Refresh** after completion.

6. Select **Select or add servers to manage and verify IPAM access**.
7. Observe that **IPAM Access Status = Blocked** (expected).

------------------------------------------------------------

### Task 3: Provision IPAM to manage servers

1. On **LON-SVR2**, open **Windows PowerShell ISE**.
2. Run:
   - `Invoke-IpamGpoProvisioning -Domain "Contoso.com" -DomainController "lon-dc1.Contoso.com" -GpoPrefixName "IPAM" -IpamServerFqdn "LON-SVR2.Contoso.com" -DelegatedGpoUser "Administrator"`

3. When prompted, select **Yes** at all confirmations.
4. Close PowerShell ISE.

------------------------------------------------------------

### Grant permissions to IPAMUG group

1. Switch to **LON-DC1**.
2. Open **Active Directory Administrative Center**.
3. Select **Global Search**, search for `IPAMUG`.
4. Open **IPAMUG**.
5. Set **Group scope** to **Global**.
6. Under **Member Of**, select **Add**.
7. Add **Domain Admins** → **OK**.
8. Close all windows.

------------------------------------------------------------

### Finalize IPAM provisioning

1. Restart **LON-SVR2**.
2. Sign in as `Contoso\Administrator` / `Pa55w.rd`.
3. Open **Server Manager** → **IPAM** → **SERVER INVENTORY**.

4. For each server listed:
   - Right-click → **Edit Server**
   - Set **Manageability status** to **Managed**
   - Select **OK**

   Servers:
   - LON-DC1
   - LON-SVR1
   - TOR-SVR1
   - SYD-SVR1

> If GPO errors occur:
> - Set status back to **Unspecified**
> - Restart **all servers**
> - Run `gpupdate /force` on all servers

5. On each server, run:
   - `gpupdate /force`

6. Back on **LON-SVR2**, refresh **Server Access Status**.
7. Select **Retrieve data from managed servers**.

**Result:** IPAM successfully provisioned.

------------------------------------------------------------

## EXERCISE 3: MANAGE IP ADDRESS SPACES USING IPAM

### Scenario
You will:
- Add a static IP address block for Toronto
- Create a DHCP reservation
- Deactivate the Portland wired DHCP scope

------------------------------------------------------------

### Task 1: Add an IP address block

1. On **LON-SVR2**, open **Server Manager** → **IP Address Blocks**.
2. In **IPv4**, switch **Current view** to **IP Address Ranges**.
3. Select **TASKS** → **Add IP Address Block**.
4. Enter:
   - Network ID: `172.16.18.0`
   - Prefix length: `24`
   - Start IP: `172.16.18.0`
   - End IP: `172.16.18.255`
   - Description: `Toronto subnet`
5. Select **OK**.

------------------------------------------------------------

### Task 2: Create an IP address reservation

1. In **IP Address Ranges**, locate `172.16.20.0/23`.
2. Right-click → **Edit IP Address Range**.
3. Select **Reservations**.
4. Enter:
   - `172.16.20.200`
5. Select **Add** → **OK**.

------------------------------------------------------------

### Task 3: Deactivate the Portland wired scope

1. In **IPAM**, select **DHCP Scopes**.
2. Right-click the first scope with **Scope ID: 172.16.23.0** → **Deactivate DHCP Scope**.
3. Repeat for the second scope with the same Scope ID.

> This deactivates both scopes created by DHCP failover.

------------------------------------------------------------

## RESULTS
- IPAM successfully installed and provisioned
- Servers centrally managed via IPAM
- IP address blocks, reservations, and scopes updated correctly
